{% extends "layouts/base.html" %}

{% block title %} Edit Templates {% endblock %} 

{% block stylesheets %}
<link rel="stylesheet" href="{{url_for('static', filename='/jstree/dist/themes/default/style.min.css')}}" />
<link rel="stylesheet" href="./../../dist/themes/default/style.min.css" />
{% endblock stylesheets %}

{% block content %}
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="{{url_for('static', filename='/jstree/dist/jstree.min.js')}}"></script>
	<style>
		.demo { overflow:auto; border:1px solid silver; min-height:100px; }
		.openBtn {
			display: flex;
			justify-content: left;
		}
		.openButton {
			border: none;
			border-radius: 5px;
			background-color: #1c87c9;
			color: white;
			padding: 14px 20px;
			cursor: pointer;
			position: fixed;
		}
		.newWorkflow {
			position: relative;
			text-align: center;
			width: 100%;
		}
		.formPopup {
			display: none;
			position: fixed;
			left: 45%;
			top: 5%;
			transform: translate(-50%, 5%);
			border: 3px solid #999999;
			z-index: 9;
		}
		.formContainer {
			max-width: 300px;
			padding: 20px;
			background-color: #fff;
		}
		.formContainer input[type=text],
		.formContainer input[type=text] {
			width: 100%;
			padding: 15px;
			margin: 5px 0 20px 0;
			border: none;
			background: #eee;
		}
		/*.formContainer input[type=text]:focus,*/
		.formContainer .btn {
			padding: 12px 20px;
			border: none;
			background-color: #8ebf42;
			color: #fff;
			cursor: pointer;
			width: 100%;
			margin-bottom: 15px;
			opacity: 0.8;
		}
		.formContainer .cancel {
			background-color: #cc0000;
		}
		.formContainer .btn:hover,
		.openButton:hover {
			opacity: 1;
		}
	</style>
<script>
	function openPopup(data, direction) {
		var nodePath = "";
		var node = data.instance.get_node(data.selected[0]);
		if(node.icon == "jstree-ok") {
			var parentNode = data.instance.get_node(node.parent);
			var nodeText = node.text;

			var operationTypes = ["Rename", "New", "Delete", "Edit"];
			var nodeTypes = ["Folder", "Template"];
			for (operationType of operationTypes) {
				for (nodeType of nodeTypes) {
					var searchString = operationType + " " + nodeType;
					if(operationType != "New") {
						searchString += " \"";
					}
					if(nodeText.startsWith(searchString)) {
						var selectedOperationType = operationType;
						var selectedNodeType = nodeType;
						var nodePath = parentNode.text + "/" + nodeText.replace(searchString, "");
						if(operationType != "New") {
							nodePath = nodePath.slice(0, -1)
						}
					}
				}
			};

			var displayText = selectedOperationType + " " + selectedNodeType;
			var parentNodeDisplayText = "";
			if(selectedOperationType == 'Edit' || (selectedOperationType == 'Delete' && selectedNodeType == "Template")) {
				var folder = data.instance.get_node(parentNode.parent).text;
				displayText += " " + folder + "/" + parentNode.text
				document.getElementById(direction + "Folder").value = folder;
				document.getElementById(direction + "Template").value = parentNode.text;
			}
			else if(selectedNodeType == "Folder" && selectedOperationType != "New") {
				displayText += " " + parentNode.text;
				document.getElementById(direction + "Folder").value = parentNode.text;
			}
			else if(selectedNodeType != "Folder" && selectedOperationType == "New") {
				parentNodeDisplayText = parentNode.text + "/...";
				document.getElementById(direction + "Folder").value = parentNode.text
			}
			else if(selectedNodeType != "Folder") {
				displayText += " " + parentNode.text
				parentNodeDisplayText = data.instance.get_node(parentNode.parent).text + "/...";
				document.getElementById(direction + "Folder").value = data.instance.get_node(parentNode.parent).text
				document.getElementById(direction + "Template").value = parentNode.text;
			}

			if(selectedOperationType == 'Delete' || selectedOperationType == 'Edit') {
				document.getElementById(direction + "PopupTextField").value = parentNode.text;
				// document.getElementById("outboundPopupTextField").disabled = true;
				document.getElementById(direction + "PopupTextField").style.display = "none";
				document.getElementById(direction + "PopupSubmitButton").innerHTML = "Confirm";
			}
			else {
				// document.getElementById("outboundPopupTextField").disabled = false;
				document.getElementById(direction + "PopupTextField").style.display = "block";
				document.getElementById(direction + "PopupSubmitButton").innerHTML = "Submit";
			}

			document.getElementById(direction + "NodeType").value = selectedNodeType;
			document.getElementById(direction + "Operation").value = selectedOperationType;
			document.getElementById(direction + "Popup").style.display = "block";
			document.getElementById(direction + "PopupSubHeader").innerHTML = parentNodeDisplayText;
			document.getElementById(direction + "PopupHeader").innerHTML = displayText;
		}
	};
	function closePopup(direction) {
		document.getElementById(direction + "Popup").style.display = "none";
	};
	function formOperation(operationType, operationTarget, parentFolderName, templateName) {
		// if(operationType == "New") {

		// }
	};
    $(function() {
      $('a#popupSubmit').on('click', function(e) {
        e.preventDefault()
        $.postJSON('/background_process_test',
            function(data) {
          //do nothing
        });
        return false;
      });
    });
</script>
</head>
	<div class="content">
		<div class="page-inner">
			{{ validation_error_card | safe}}
			<div class="row">
				<div class="col-md-6">
					<div class="card">
						<div class="card-header">
							<h4 class="card-title">Outbound {{ template_type_name }} Templates</h4>
						</div>
						<div class="card-body">
							<div id="evts" class="demo">
								<ul>
									{{outbound_tree_format_text | safe}}
								</ul>
							</div>

							<script>
								// interaction and events
								$('#evts_button').on("click", function () {
									var instance = $('#evts').jstree(true);
									instance.deselect_all();
									instance.select_node('1');
								});
								$('#evts')
									.on("changed.jstree", function (e, data) {
										if(data.selected.length) {
											openPopup(data, 'outbound')
											// openOutboundPopup(data.instance.get_node(data.instance.get_node(data.selected[0]).parent).text)
												// data.instance.get_node(data.selected[0]).text)
										}
									})
									.jstree({{ outbound_tree_format_code | safe }});
							</script>
							<!-- Begin Edit Files Forms -->
							<div class="outboundPopup">
								<div class="formPopup" id="outboundPopup">
									<form action="/builder_submit" class="formContainer" method="post">
										<h2 id="outboundPopupHeader"></h2>
										<label for="outboundPopupTextField">
											<strong id="outboundPopupSubHeader" style="color:black"></strong>
										</label>
										<input type="text" id="outboundPopupTextField" placeholder="" name="submitted_name" required>
										<input type="text" id="outboundOperation" placeholder="" name="operation" style="display:none" required>
										<input type="text" id="outboundNodeType" placeholder="" name="node_type" style="display:none" required>
										<input type="text" id="outboundFolder" placeholder="" name="folder" style="display:none">
										<input type="text" id="outboundTemplate" placeholder="" name="template" style="display:none">
										<input type="text" id="outboundTemplateType" name="template_type" style="display:none" value="{{ outbound_template_type }}">
										<input type="text" id="outboundTemplateTypeName" name="template_type_name" style="display:none" value="{{ template_type_name }}">
										<button type="submit" class="btn" id="outboundPopupSubmitButton"></button>
										<button type="button" class="btn cancel" onclick="closePopup('outbound')">Cancel</button>
									</form>
								</div>
							</div>
							<!-- End Edit Files Forms -->
						</div>
					</div>
				</div>
				{{ edit_inbound_disabled_start | safe }}
				<div class="col-md-6">
					<div class="card">
						<div class="card-header">
							<h4 class="card-title">Inbound {{ template_type_name }} Templates</h4>
						</div>
						<div class="card-body">
							<div id="inbound-tree" class="demo">
								<ul>
									{{inbound_tree_format_text | safe}}
								</ul>
							</div>

							<script>
								// interaction and events
								$('#inbound-tree-button').on("click", function () {
									var instance = $('#inbound-tree').jstree(true);
									instance.deselect_all();
									instance.select_node('1');
								});
								$('#inbound-tree')
									.on("changed.jstree", function (e, data) {
										if(data.selected.length) {
											openPopup(data, 'inbound')
										}
									})
									.jstree({{ inbound_tree_format_code | safe }});
							</script>
							<div class="inboundPopup">
								<div class="formPopup" id="inboundPopup">
									<form action="/builder_submit" class="formContainer" method="post">
										<h2 id="inboundPopupHeader"></h2>
										<label for="inboundPopupTextField">
											<strong id="inboundPopupSubHeader" style="color:black"></strong>
										</label>
										<input type="text" id="inboundPopupTextField" placeholder="" name="submitted_name" required>
										<input type="text" id="inboundOperation" placeholder="" name="operation" style="display:none" required>
										<input type="text" id="inboundNodeType" placeholder="" name="node_type" style="display:none" required>
										<input type="text" id="inboundFolder" placeholder="" name="folder" style="display:none">
										<input type="text" id="inboundTemplate" placeholder="" name="template" style="display:none">
										<input type="text" id="inboundTemplateType" name="template_type" style="display:none" value="{{ inbound_template_type }}">
										<input type="text" id="inboundTemplateTypeName" name="template_type_name" style="display:none" value="{{ template_type_name }}">
										<button type="submit" class="btn" id="inboundPopupSubmitButton"></button>
										<button type="button" class="btn cancel" onclick="closePopup('inbound')">Cancel</button>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
				{{ edit_inbound_disabled_end | safe }}
			</div>
		</div>
	</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script src="{{url_for('static', filename='/jstree/dist/jstree.min.js')}}"></script>

{% endblock javascripts %}
